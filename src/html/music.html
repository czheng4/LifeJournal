<!--
    music.html
    Hunter Leef
    10/28/19
    This is currently functioning music player
-->

<!DOCTYPE html>
<html>
    <head>
    	<title>Music Player</title>
    	<link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">
        <link href="../../fontawesome/css/all.css" rel="stylesheet">
        <style type="text/css">
            h1, h2, h3{
                text-align: center;
            }
            div{
                margin-bottom: 5px;
            }
            div:last-of-type{
                margin-bottom: 0px;
            }
            .button_container{
                text-align: center;
            }
            .upbutton{
                background-color: whitesmoke;
                color: black;
                border: 2px solid rgb(41, 172, 224);
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                border-radius: 8px;
            }
            .upbutton:hover{
                background-color: rgb(41, 172, 224);
                color: whitesmoke;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                border-radius: 8px;
            }
            .delbutton{
                background-color: whitesmoke;
                color: black;
                border: 2px solid maroon;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                border-radius: 8px;
            }
            .delbutton:hover{
                background-color: maroon;
                color: whitesmoke;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                border-radius: 8px;
            }
            .pbutton{
                background-color: forestgreen;
                color: whitesmoke;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                padding: 8px;
                border-radius: 50%;
            }
            .tbutton{
                background-color: #EFEFF0;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                border-radius: 35%;
                border: transparent;
            }
            .light_button{
                background-color: #EFEFF0;
                color: #1F1F1F;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 10px;
                padding: 4px;
                border-radius: 15%;
            }
            .dark_button{
                background-color: #1F1F1F;
                color: #EFEFF0;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 10px;
                padding: 4px;
                border-radius: 15%;
            }
            .blue_button{
                background-color: #5FD0FE;
                color: #EFEFF0;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 10px;
                padding: 4px;
                border-radius: 15%;
            }
            .volume_container{
                width: 50%;
                text-align: center;
            }
            .vol_slider{
                -webkit-appearance: none;
                width: 50%;
                height: 5px;
                background: #d3d3d3;
                outline: none;
                opacity: 0.65;
                -webkit-transition: .2s;
                transition: opacity .2s;
            }
            .vol_slider:hover{
                opacity: 1;
            }
            .vol_slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 10px;
                height: 10px;
                background: rgb(87, 67, 201);
                cursor: pointer;
            }
            .vol_slider::-moz-range-thumb {
                width: 10px;
                height: 10px;
                background: rgb(87, 67, 201);
                cursor: pointer;
            }
        </style>
    </head>

    <body>
        <div class= "container">
            <h3>Controls</h3>
            <div class="button_container">
                <button id = "upload" type="button" class="upbutton">Upload Music</button>
                &nbsp;&nbsp;
                <button id = "delete" type="button" class="delbutton">Delete Selected Music</button>
                &nbsp;&nbsp;
                <button id = "refresh" type="button" class="upbutton">Refresh Playlist</button>
            </div>
            <div class="button_container">
                <button id = "prev" type="button" class="tbutton" title="skip to previous"><img src="../../image/prev.png"></button>
                &nbsp;
                <button id = "rewind" type="button" class="tbutton" title="rewind"><img src="../../image/rewind_button.png" alt="rewind"></button>
                &nbsp;
                <button id = "play" type="button" class="tbutton" title="play/pause"><img src="../../image/play_button.png" alt="play"></button>
                &nbsp;
                <button id = "playRand" type="button" class="tbutton" title="play random"><img src="../../image/shuffle_button.png" alt="random"></button>
                &nbsp;
                <button id = "fastForward" type="button" class="tbutton" title="fast forward"><img src="../../image/fast_forward.png" alt="forward"></button>
                &nbsp;
                <button id = "next" type="button" class="tbutton" title="skip to next"><img src="../../image/skip.png"></button>
                <h3>Time skip (in seconds)</h3>
                <form>
                    <input type="radio" name="speed" id="speed1" value="5" checked> 5&nbsp;
                    <input type="radio" name="speed" id="speed2" value="15"> 15&nbsp;
                    <input type="radio" name="speed" id="speed3" value="30"> 30
                </form>
            </div>
            <div class="volume_container">
                <p>Volume Controller</p>
                <input type="range" min="0" max="100" value="100" class="vol_slider" id="vol_con">
                <p><span id="vol_level"></span></p>
            </div>
            <div class="button_container">
                <h3>Color Themes</h3>
                <button id = "light" type="button" class="light_button">Light</button>
                &nbsp;
                <button id = "dark" type="button" class="dark_button">Dark</button>
                &nbsp;
                <button id = "blue" type="button" class="blue_button">Blue</button>
            </div>
            <div>
                <h1>Currently Playing</h1>
                <div id="currently_playing"></div>
                <h2>Playlist (Check Box for Deletion)</h2>
                <div id="playlist"></div>
            </div>
        </div>
        <script type="text/javascript">
            const $ = require("jQuery");
            const fs = require("fs");
            var musicThread = require('electron').ipcRenderer;
            var remote = require('electron').remote;  
            var user = remote.getGlobal('share').user;
            var audio_path = "";
            var audio = null;
            var music_list = [];
            var music_ind = 0;
            var music_titles_list = [];
            var attach = "";
            var data = "";
            var incr = 5;
            var dec = 5;
            var vol_slider = document.getElementById("vol_con");
            var curr_vol = document.getElementById("vol_level");
            var change_vol = 0;

            curr_vol.innerHTML = vol_slider.value;
            // A function for displaying the currently uploaded music available for playback
            function showMusic(){
                music_list = [];
                music_titles_list = [];
                $("#playlist").empty();
                path = "../../data/" + user + "/music/";
		        fs.readdir("./data/" + user + "/music",(err,files) =>{
                    if(err) throw err;
                    var music_list_length = files.length;
			        for(var i = 0; i < music_list_length; i++) 
			        {
                        audio_path = path + files[i];
                        var slice = files[i].slice(0, files[i].length - 4);
                        audio = new Audio(audio_path);
                        music_list.push(audio);
                        /*if(i > 0){
                            music_list[i-1].addEventListener('ended', (event) => {
                                music_list[i].play();
                            });
                            if(i === music_list_length - 1){
                                music_list[i].addEventListener('ended', (event) => {
                                    music_list[0].play();
                                }); 
                            }
                        } */
                        attach = "<body>" + "<b>" + slice + "</b>" + "</body>";
                        music_titles_list.push(attach);
                        // This creates a checkbox element
                        attach = "<label><input type=\"checkbox\" name=\"checkbox\" id = \"song" + i + "\">" + slice + "</label>";
                        $("#playlist").append(attach);
			        }
                    music_list_length = music_list.length;
                    music_ind = 0;
                    audio = music_list[music_ind];
                })
            }
            // simple function to change the background color and text color of the music player
            function changeColor(bg_color, text_color){
                    document.body.style.backgroundColor = bg_color;
                    document.body.style.color = text_color;
            }
            // compare current song's volume with the selected slider volume
            // if they are different, change current song's volume to that of the slider's
            function checkVol(audio){
                change_vol = parseInt(vol_slider.value) / 100.00
                if(audio.volume !== change_vol) audio.volume = change_vol;
            }
            // volume adjustment func
            vol_slider.oninput = function(){
                curr_vol.innerHTML = this.value;
                if(audio !== null && audio === music_list[music_ind]){
                    audio.volume = parseInt(this.value) / 100.0;
                }
            }
            $(document).ready(function(){
                showMusic();
                music_list_length = music_list.length;
                // Try to find if the user has an already selected color theme
                var bg_path = './data/' + user + "/bg.txt";
                try{
                    // if they do, let it happen
                    if(fs.existsSync(bg_path)){
                        fs.readFile(bg_path, 'utf-8', (err, data) => {
                            if(err) throw err;

                            var bg_opts = data.split('\n');
                            changeColor(bg_opts[0], bg_opts[1]);
                        })
                    }
                    else{ // otherwise use default light theme
                        changeColor("#EFEFF0", "#1F1F1F");
                    }
                }catch(err){
                    console.error(err);
                }
                // this will allow the user to upload music files (only mp3)
                $("#upload").click(function(){
                    musicThread.send("upload","music/");
                })
                // refresh button re-displays any of the uploaded music to the playlist
                $("#refresh").click(function(){
                    showMusic();
                })
                // play button will play the first song on the playlist, or if one was already playing
                // it will pause it and if clicked one additional time, re-play it
                $("#play").click(function(){
                    if(music_ind >= music_list.length){
                        music_ind = 0;
                    }
                    if(audio !== null && audio.currentTime > 0 && !audio.paused){
                        $("#currently_playing").empty();
                        checkVol(audio);
                        audio.pause();
                    }
                    else if(audio !== null && (audio.currentTime === 0 || audio.paused)){
                        $("#currently_playing").empty();
                        if(audio !== music_list[music_ind]) audio = music_list[music_ind];
                        $("#currently_playing").append(music_titles_list[music_ind]);
                        checkVol(audio);
                        audio.play();
                    }
                    else if(audio === null){
                        audio = music_list[music_ind];
                        $("#currently_playing").empty();
                        $("#currently_playing").append(music_titles_list[music_ind]);
                        checkVol(audio);
                        audio.play();
                    }
                })
                // find a "random" song from the playlist to play, it will ensure that the current song
                // is not repeated if there is one
                $("#playRand").click(function(){
                    var old_ind = music_ind;
                    while(old_ind === music_ind){
                        music_ind = parseInt((Math.random() * music_list.length), 10);
                    }
                    if(audio !== null){
                        
                        audio.pause();
                        audio.currentTime = 0;
                    }
                    audio = music_list[music_ind];
                    $("#currently_playing").empty();
                    $("#currently_playing").append(music_titles_list[music_ind]);
                    checkVol(audio);
                    audio.play();
                })
                $("#fastForward").click(function(){
                    if(audio !== null){
                        if(audio !== music_list[music_ind]) audio = music_list[music_ind];
                        if(!audio.paused) audio.pause;
                        if(!document.getElementById("speed1").checked){
                            if(document.getElementById("speed2").checked) incr = 15;
                            else incr = 30;
                        }
                        if((audio.currentTime + incr) < audio.duration) audio.currentTime += incr;
                        else{
                            audio.pause();
                            audio.currentTime = 0;
                            music_ind = (music_ind + 1) % music_list.length;
                            audio = music_list[music_ind];
                            $("#currently_playing").empty();
                            $("#currently_playing").append(music_titles_list[music_ind]);
                        }
                        checkVol(audio);
                        audio.play();
                    }
                })
                $("#rewind").click(function(){
                    if(audio !== null){
                        if(audio !== music_list[music_ind]) audio = music_list[music_ind];
                        if(!audio.paused) audio.pause;
                        if(!document.getElementById("speed1").checked){
                            if(document.getElementById("speed2").checked) dec = 15;
                            else dec = 30;
                        }
                        if((audio.currentTime - dec) >= 0) audio.currentTime -= dec;
                        else{
                            audio.pause();
                            audio.currentTime = 0;
                            music_ind -= 1;
                            if(music_ind < 0) music_ind = music_list.length - 1;
                            audio = music_list[music_ind];
                            $("#currently_playing").empty();
                            $("#currently_playing").append(music_titles_list[music_ind]);
                        }
                        checkVol(audio);
                        audio.play();
                    }
                })
                // skip to the song following the current song
                $("#next").click(function(){
                    music_ind = (music_ind + 1) % music_list.length;
                    if(music_ind >= music_list.length){
                        music_ind = 0;
                    }
                    if(audio !== null){ 
                        audio.pause();
                        audio.currentTime = 0; 
                    }
                    audio = music_list[music_ind];
                    $("#currently_playing").empty();
                    $("#currently_playing").append(music_titles_list[music_ind]);
                    checkVol(audio);
                    audio.play();
                })
                // skip backward from current song
                $("#prev").click(function(){
                    music_ind -= 1;
                    if(music_ind < 0){
                        music_ind = music_list.length - 1;
                    }
                    if(audio !== null){ 
                        audio.pause();
                        audio.currentTime = 0; 
                    }
                    audio = music_list[music_ind];
                    $("#currently_playing").empty();
                    $("#currently_playing").append(music_titles_list[music_ind]);
                    checkVol(audio);
                    audio.play();
                })
                // Delete will first see if a given song has had it's checkbox marked, and if it has
                // then that song will be removed from the playlist
                $("#delete").click(function(){
                    var chequebox;
                    var path_del = "./data/" + user + "/music/"; // path relative to main.js
                    fs.readdir("./data/" + user + "/music",(err,files) =>{
                        if(err) throw err;
                      
			            for(var i = 0; i < files.length; i++) 
			            {
                            id = "song" + i;
                            chequebox = document.getElementById(id);
                            if(chequebox.checked){
                                var audio_path_del = path_del + files[i];
                                fs.unlinkSync(audio_path_del,(err) => {if (err) throw err; });
                            }
                        }
                        $("#currently_playing").empty();
                        showMusic();
                    })
                })
                // the following three just change the color theme of the player
                $("#light").click(function(){
                    changeColor("#EFEFF0", "#1F1F1F");
                    data = "#EFEFF0" + '\n' + "#1F1F1F";
                    fs.writeFile(bg_path, data, (err) => {
                        if(err) throw err;
                    })
                })
                $("#dark").click(function(){
                    changeColor("#1F1F1F", "#EFEFF0");
                    data = "#1F1F1F" + '\n' + "#EFEFF0";
                    fs.writeFile(bg_path, data, (err) => {
                        if(err) throw err;
                    })
                })
                $("#blue").click(function(){
                    changeColor("#5FD0FE", "#EFEFF0");
                    data = "#5FD0FE" + '\n' + "#EFEFF0";
                    fs.writeFile(bg_path, data, (err) => {
                        if(err) throw err;
                    })
                })
            })
        </script>
    </body>
</html>