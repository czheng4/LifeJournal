<!--
    music.html
    ChaoHui Zheng
    12/14/2019
-->

<!DOCTYPE html>
<html>
    <head>
        <title>Music Player</title>
        <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">
        <link href="../../fontawesome/css/all.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="../css/light.css">
        <style type="text/css">
        body
        {
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .topFeature
        {
            position: fixed;
            background-color: var(--nav-color);
            height: 60px;
            width: 100%;
            z-index: 2;
        }

        .bottomFeature
        {
            position: fixed;
            background-color: var(--nav-color);
            bottom: 0px;
            height: 60px;
            width: 100%;
            z-index: 2;
        }
        button
        {
            border: none;   
            color:var(--text-color);
            background-color: var(--nav-color);
            margin-top: 5px;
            font-size: 20px;

        }
        button .shortcut, a .shortcut
        {
            font-size:17px;
            visibility: hidden;
            width: 90px;
            
            background-color: var(--page-background);
            color:var(--text-color);
            
            text-align: center;
            border-radius: 6px;
            position: absolute;
            bottom: 20%;
            left: -95%;
            z-index: 1;

        }
        button:hover .shortcut, a:hover .shortcut
        {
            visibility: visible;
        }
        
        button:focus
        {
            outline:none;
        }
        .playOrder
        {
            position: absolute;
            top:40px;
            left:45%;
            width:170px;
            height: 105px;
            padding: 0px 0px 0px 0px;
            display: none;
            z-index: 2;
            background-color: var(--theme-l2);
            border-radius: 5px;
        }
        .create
        {
            position: fixed;
            top:38%;
            width: 80%;
            height: 24%;
            left:10%;
            z-index: 2;
            background-color: var(--theme-l1);
            color: var(--text-color);
            border-radius: 5px;
            display: none;
            
        }

        .importCategory
        {
            position: fixed;
            top:25%;
            text-align: center;
            width: 80%;
            height: 50%;
            left:10%;
            border-radius: 10px;
            z-index: 2;
            background-color: var(--theme-l1);  
            display: none;
        }
        .categoryDropdown
        {
            font-size: 20px;  
            border: none;
            outline: none;
            padding: 7px 16px;
            background-color: var(--theme-l2);
            position: relative;
            text-align: left;
            margin-left: 5%;
            margin-right: 5%;
            margin-top: 5%;
            width: 90%;
            border-radius: 13px;

        }
        .categoryDropdown:focus
        {
            outline:none;
        }

        .categoryContent
        {   
            transition: 0.5s;
            position: absolute;
            margin-left: 5%;
            width: 90%;
            background-color: var(--theme-l3);
            box-shadow: 0px 4px 8px 0px;
            max-height: 100px;
            z-index: 2;
            max-height: 0%;
            overflow: scroll;
            border-radius: 10px;
            
        }
        .categoryContent a 
        {
            color: var(--text-color);
            padding: 7px 16px;
            text-decoration: none;
            display: block;
            text-align: left;

        }
        .categoryContent a:hover
        {
            background-color: pink;
        }
        hr
        {
            background-color: black;
            margin: -1px 0px 0px 0px;
        }
        .musicContent
        {
            position: fixed;
            overflow: scroll;
            top: 70px;
            bottom: 70px;
            width: 100%;
        }

      
        .musicCategoryTitle
        {
           position: absolute;
           width: 100%;
           padding-left: 20px;   
           cursor: pointer;
           background-color: var(--theme-l3);
           color: var(--text-color);
           z-index: 2;
        }
        .musicCategorySong
        {   
            margin-left: 20px;
        }
        .musicCategorySong a
        {
            cursor: pointer;
            margin-left: 17px;
            margin-right: 30px;
            color: inherit;
           
        }
        .volumeController
        {
            color:blue;
            position:absolute; 
            left: 41%; 
            margin-top: 15px; 
            display: block;
        }
        a:hover
        {
            text-decoration: none;
        }
        .volumeSlider
        {
            -webkit-appearance: none;
            background: linear-gradient(to right, green 0%, green 50%, #fff 50%, #fff 100%);
            border: solid 1px #00b300;
            border-radius: 8px;
            height: 7px;
            width: 10%;
            outline: none; 
            left: 38.5%; 
            margin-top: 40px; 
            position: absolute;
            transition: background 450ms ease-in;
        }

        .musicSlider
        {
            -webkit-appearance: none;
            border: solid 1px #00b300;
            border-radius: 8px;
            height: 7px;
            width: 27%;
            outline: none; 
            left: 6%; 
            margin-top: 20px; 
            position: absolute;
        }
        .musicCurrentTime
        {
            width: 5%;
            text-align: right;
            margin-top: 10px; 
            position: absolute;

        }
        .musicDuration
        {
            width: 5%;
            text-align: left;
            margin-top: 10px; 
            position: absolute;
            left:34%;

        }
        .playingSongName
        {
            text-align: left;
            margin-top: 35px; 
            position: absolute;
            left:6%;
        }

        .playList
        {
            position: fixed;
            z-index: 2;
            left:50%;
            width: 50%;
            height: 50%;
            bottom: 60px;
            overflow: scroll;
            background-color: var(--theme-l2);
            visibility: hidden;
            border-radius: 10px;
        }
        .playList button
        {
            background-color: var(--theme-l2);
            position:absolute; 
            right: 15px; 
            font-size:1rem; 
            margin-top:-2px;
            border:none;
            outline: none;
        }
        hr
        {
            color: var(--hr-line);
            background-color: var(--hr-line);
        }
        .playList div hr
        {
            margin: 2px 0px 2px 0px;
            background-color: var(--hr-line);
        }
      
        .playList a
        {
            cursor: pointer;
            margin-left: 15px;
            margin-right: 30px;
            text-decoration: none;
            color:inherit;
        }
        
    </style>
    </head>

    <body>

        <div class = "topFeature">
            <div style="position: relative">
            
                <input type="text" id = "search" style = "font-size: 18px;width: 40%;position: absolute;left: 15px;top:15px; border-radius: 5px"placeholder="Search ...">


                <button id = "order" style = "position:absolute; left: 48%"><i class="fas fa-long-arrow-alt-right"></i><span class = "shortcut"> ctr-o/alt-o </span></button>
                <button id = "transfer" style = "position:absolute; left: 57%"> <i class="fas fa-arrow-right"></i><span class = "shortcut"> ctr-t/alt-t </span></button>
                <button id = "delete" style = "position:absolute; left: 66%"> <i class="fas fa-trash"></i><span class = "shortcut"> ctr-d/alt-d </span></button>
                
                <button id = "upload" style = "position:absolute; left: 75%"><i class="fas fa-file-import"></i><span class = "shortcut"> ctr-i/alt-i </span></button>
                
                <button id = "createCategoryWindow" style = "position:absolute; left: 84%"> <i class="fas fa-plus"></i><span class = "shortcut"> ctr-c/alt-c </span></button>
                
                <button id = "select" style = "position:absolute; left: 93%"><i class="fas fa-mouse-pointer"></i><span class = "shortcut"> ctr/alt-x </span></button>

              
                <span style="position: absolute; left: 47.8%; margin-top: 35px;">order</span>
                <span style="position: absolute; left: 55.9%; margin-top: 35px;">transfer</span>
                <span style="position: absolute; left: 65.4%; margin-top: 35px;">delete</span>
                <span style="position: absolute; left: 74.4%; margin-top: 35px;">import</span>
                <span style="position: absolute; left: 83.4%; margin-top: 35px;">create</span>
                <span style="position: absolute; left: 92.2%; margin-top: 35px;">select</span>
               
               
               
            </div>
        </div>
       
        <div class="bottomFeature">
            <div>
                <span class="playingSongName"></span>
               
                <span class="musicCurrentTime">0:00</span>

                <input type="range" min="0" max="11" value="0" step="1" class = "musicSlider" id = "musicSlider">
                <span class="musicDuration">0:00</span>
                
                <button id = "volume" class = "volume" style = "position:absolute; left: 41%"><i class="fas fa-volume-up"></i><span class = "shortcut"> ctr-m/alt-m </span></button>
                

                <input type="range" class = "volumeSlider"  id="start" name="volume" min="0.0" max="1.0" value = '0.5' step = 0.01>
                
                <button id = "previous" style = "position:absolute; left: 53%"><i class="fas fa-step-backward"></i><span class = "shortcut"> leftArrow </span></button>
                
                <button id = "playPause" style = "position:absolute; left: 65%" name = "pause"> <i class="fas fa-pause"></i><span class = "shortcut"> space </span></button>
                
                <button id = "next" style = "position:absolute; left: 77%"> <i class="fas fa-step-forward"></i><span class = "shortcut"> rightArrow </span></button>
                
                <button id = "playList" style = "position:absolute; left: 89%" name = "pause"> <i class="fas fa-list"></i><span class = "shortcut"> ctr-l/alt-l </span></button>
                

                <span style="position: absolute; left: 51.7%; margin-top: 35px;">previous</span>
                <span id = "playPauseText" style="position: absolute; left: 65.2%; margin-top: 35px;">play</span>
                <span style="position: absolute; left: 77%; margin-top: 35px;">next</span>
                <span style="position: absolute; left: 88.3%; margin-top: 35px;">play list</span>    
            </div>
        </div>

        <div class="playList">
            <div id="playListTitle">
                <h5 id="0_playListTitle" style="margin-left:15px; margin-top:5px;cursor:pointer">
                <i class="fas fa-arrow-right"></i>
                <span style="margin-left:15px">play in order</span> 
                </h5>
            <hr></div>
        </div>

        <!-- play order chooser -->
        <div class = "playOrder">
            <span id = "inOrder" style=" position: relative; left: 20px; top: 5px; cursor: pointer;"><i class="fas fa-long-arrow-alt-right" name = "0"></i>&emsp;in order&emsp;<i class="fas fa-check" style="visibility: hidden;"></i></span>
            <hr style="margin: 10px 0px 5px 0px;">
             <span id = "random" style=" position: relative; left: 20px; cursor: pointer; "><i class="fas fa-random" name = "1"></i>&emsp;random&emsp;<i class="fas fa-check" style="visibility: hidden;"></i></span>
            <hr style="margin: 5px 0px 5px 0px;">
            <span id = "single" style=" width: 100%; position: relative; left: 20px; cursor: pointer;"> <i class="fas fa-recycle" name = "2"></i></i>&emsp;single&emsp;&ensp;&nbsp;<i class="fas fa-check" style="visibility: hidden;"></i></span>

        </div>

        <!-- create a new album -->
        <div class="create">
           
            <input type="text" id = "categoryName" class="form-control" placeholder="Enter category name" style="width: 90%; margin-left: 5%; margin-top: 10px;">

            <div style="text-align: right; position: absolute; right: 5%; bottom: 10px;">
                <button id = "cancelCategory" type="button" class="btn btn-primary">Cancel</button>
                &nbsp;&nbsp;
                <button id = "createCategory" type="button" class="btn btn-danger">Create</button>
            </div>
        </div>

        <!-- choose the category to import -->
        <div class="importCategory">
            <button class = "categoryDropdown" type="button"><span id = "chosenCategory">Import to ...</span><i class="fa fa-caret-down" style="position:absolute; left:90%; font-size: 30px"></i></button>
            <div class = "categoryContent"> 
            </div>
            
            <div style="text-align: right; position: absolute; right: 5%; bottom: 10px;">
                <button id = "cancelImportTransfer" type="button" class="btn btn-primary" style="width: 100px">Cancel</button>
                &nbsp;&nbsp;
                <button id = "yesImportTransfer" type="button" class="btn btn-danger" style="width: 100px">yes</button>
            </div>
        </div>

        <div id = "musicContent" class="musicContent">
        </div>

    </body>
   
    <script type="text/javascript">
        const $ = require("jQuery");
        const remote = require('electron').remote;
        const {File} = require("../js/file.js");
        const musicThread = require('electron').ipcRenderer;
        const {Confirmation} = require("../js/confirmation.js");
        const fs = require("fs");
        const user = remote.getGlobal('share').user;  
        const path = "./data/" + user + "/music/";
        const {Music,secondsToTimeString,generatePlayList,findMusicOfList,updateMusicFromList} = require("../js/music.js")
        const setting = new File("./data/" + user + "/setting.txt");
        const {changeThemeMode, loadThemeMode} = require("../js/theme.js"); loadThemeMode();
        const playOrderTypes = ['i','r','s'];
        var playingMusic = new Audio();
        playingMusic.volume = 0.5;
        var musicDict = {};
        var musicListDict = {};
        var newMusic;
        var myMusicCategory = null;
        var myMusicCurrentTime = -1;
        var myMusicDuration = 0;
        var myVolume = 0;
        var visible = {false:"hidden",true:"visible"};
        var isSelect = false;
        var typeTransferImport = "";
        var playOrder;
        var playingMusicNode = null;
        var musicNodePointers = [];
        var case_sensitive = (setting.readDict()["caseSensitive"] == "on");

        var renameMusic = null;
        var orderType = 'i'; // i is in order, s is single, r is random
        var playListTitle = {0:'<h5 id = "0_playListTitle" style="margin-left:15px; margin-top:5px;cursor:pointer">\
                                    <i class="fas fa-arrow-right"></i>\
                                    <span style="margin-left:15px">play in order</span>\
                                </h5><hr>',
                            1:'<h5 id = "1_playListTitle" style="margin-left:15px; margin-top:5px; cursor:pointer">\
                                    <i class="fas fa-random"></i>\
                                    <span style="margin-left:15px">play in random order</span>\
                                    <span style="right:15px; position:absolute">shuffle</span>\
                                </h5><hr>',
                            2:'<h5 id = "2_playListTitle" style="margin-left:15px; margin-top:5px; cursor:pointer">\
                                    <i class="fas fa-recycle"></i>\
                                    <span style="margin-left:15px">single cycle</span>\
                                </h5><hr>'

        }

        

$(document).ready(function(){
        playOrder = $("#inOrder"); 

        musicThread.send("MUSIC_REGISTER");
        
        showMusic();
        showMusicList();

       
        $("body").on("click",".playList #playListTitle",function(){
            let indexOfTitle = (parseInt( $("#playListTitle").children()[0].id) + 1) % 3;
            updatePlayListOrder(indexOfTitle);


            /* update the play order in the main page */
            $("#order").text("");
            if(indexOfTitle  == 0) $("#order").append('<i class="fas fa-arrow-right"></i><span class = "shortcut"> ctr-o/alt-o </span>');
            else if(indexOfTitle == 1) $("#order").append('<i class="fas fa-random"></i><span class = "shortcut"> ctr-o/alt-o </span>');
            else $("#order").append('<i class="fas fa-recycle"></i><span class = "shortcut"> ctr-o/alt-o </span>');
            
        });

        $("body").on("click",".playList div a",function(){
            let index = $(this).attr("name");

            if($("#playPause").attr("name") == "pause")
            {   
                $("#playPause").text("");
                $("#playPause").attr("name","play");
                $("#playPauseText").text("pause");
                $("#playPause").append('<i class="fas fa-play"></i><span class = "shortcut"> space </span>');
            } 
            if(playingMusicNode != null)
            {
                $("#playList_" + playingMusicNode.val.index).css("color","");
                $("#" + playingMusicNode.val.musicIndex  + "_" + playingMusicNode.val.category).css("color","");
            }
            playingMusicNode = musicNodePointers[index];
            
            playingMusic.pause();
            playingMusic.src = playingMusicNode.val.src;
            playingMusic.play();

        })
        $("body").on("click",".playList div button",function(){
            let index = $(this).attr("name");
            
            if(playingMusicNode == musicNodePointers[index]) next();
            musicNodePointers[index].val.isdelete = true;
            musicListDict[myMusicCategory][orderType].erase(musicNodePointers[index]);
            $(this).parent().remove();
        })
        /* play order */
        $(".playOrder span").click(function(){
           
            if(playOrder != null) 
            {
                playOrder.css("color","");
                playOrder.children()[1].style.visibility = "hidden";
            }

            playOrder = $(this);
            playOrder.css("color","blue");

            updatePlayListOrder(parseInt(playOrder.children()[0].attributes.name.value));
            $("#order").text("");
            $("#order").append(playOrder.children()[0].outerHTML + '<span class = "shortcut"> ctr-o/alt-o </span>');

            $(".playOrder").css("display","none");
        })

        $("#createCategory").click(function(){
            /* remove the trailing space */
            let name = $("#categoryName").val().replace(/\s+$/,"");
            var dir = path + name;
            var content = "";

            /* check if the album exists */
            if(fs.existsSync(dir) === true) musicThread.send("errorMessage","ERROR","The album exists or is empty");
            else 
            {
                fs.mkdirSync(dir);

                if(myMusicCategory == null)
                {
                    showMusic();
                    showMusicList();
                    $(".create").css("display","none");
                    return;
                }
                content += '<div style = "margin-top:5px">\
                                <div class = "musicCategoryTitle" name = "' + name + '">' + name + '\
                                    <span style="right: 60px; position: absolute; cursor:pointer">â–¼</span>\
                                    <input type="checkbox" style="position: absolute; right: 20px; margin-top:5px; visibility:hidden" value = "" name = "myMusic_' + name + '">\
                                </div>\
                                <br>\
                            </div>\
                            <div class = "musicCategorySong" id = "myMusic_' + name + '"></div>';
                musicDict[name] = [];
                musicListDict[name] = {'i':null, 'r':null, 's':null};
                if(myMusicCategory == null) myMusicCategory = name;
                $(".create").css("display","none");
                $("#musicContent").append(content);
            }
           
        })
        $("#cancelCategory").click(function(){
             $(".create").css("display","none");
        })

        
        $(".categoryDropdown").click(function(){
            let max_height = $(".categoryContent").css("max-height");
            let dirs;
            let content = "";
            
            if(max_height == "0%")
            {
                dirs = fs.readdirSync(path);
                for(var i = 0; i < dirs.length; i++) content += '<a href = "#">' + dirs[i] + '</a>';
                $(".categoryContent").text(""); 
                $(".categoryContent").append(content);
                $(".categoryContent").css("max-height","50%");
            }
            else $(".categoryContent").css("max-height","0%");
        })

        $('body').on("click",".categoryContent a",function(){
            $("#chosenCategory").text($(this).text());    
            $(".categoryContent").css("max-height","0%");
        })

        $("#cancelImportTransfer").click(function(){
             $(".importCategory").css("display","none");
        })

        $("#yesImportTransfer").click(function(){
            let category = $("#chosenCategory").text();
            let checkboxes;
            let value,index;
            let from,to;
            let content = "";
            let category_index;
            let newFileName;
            let newNode;
            let playListContent = "";
            if(typeTransferImport == "import")
            {
                if(category == "Import to ...") musicThread.send("errorMessage","ERROR","Select one category");
                else
                {
                    $(".importCategory").css("display","none");
                    musicThread.send("upload","music/" + category + "/");
                }
            }
            else
            {
                if(category == "Transfer to ...") musicThread.send("errorMessage","ERROR","Select one category");
                else
                {
                    $(".importCategory").css("display","none");
                    checkboxes = $("[type='checkbox']");
                    to = path + category + "/";
                    
                    category_index = musicDict[category].length;
                    
                    
                    var files = fs.readdirSync(to).sort(function(t1,t2){return parseInt(t1) - parseInt(t2);});
                    
                    /* name our files with number. Therefore, we can have multiple same files */
                    if(files.length == 0) num = 1;
                    /* grab the biggest number */
                    else num =  1 + parseInt(files[files.length - 1]);
                    


                    for(var i = 0; i < checkboxes.length; i++)
                    {
                        
                        if(checkboxes[i].value != "" && checkboxes[i].checked)
                        {

                            value = checkboxes[i].value;
                            value = value.split('-');
                            index = parseInt(value[0]);

                            if(value[1] == category) continue;  // at the category we transfer to 
                           
                            musicDict[value[1]][index].isdelete = true;
                            from = musicDict[value[1]][index].filePath;
                            newFileName = num + "-" + musicDict[value[1]][index].name;
                            

                            fs.renameSync(from, to + newFileName);
                            newMusic = new Music(to + newFileName, newFileName, category);
                            newMusic.musicIndex = category_index;
                            musicDict[category].push(newMusic);
                            
                            /* update the music in the playList */
                            for(var j = 0; j < playOrderTypes.length; j++)
                            {
                                if(playOrderTypes[j] != "s" && musicListDict[category][playOrderTypes[j]] != null)
                                {
                                    newNode = musicListDict[category][playOrderTypes[j]].push_back(newMusic.deepCopy());
                                    musicDict[category][category_index].listIndices.push(musicNodePointers.length);
                                    newNode.val.index = musicNodePointers.length;
                                    newNode.val.orderType = playOrderTypes[j];
                                    musicNodePointers.push(newNode);
                       
                                    if(myMusicCategory == category && playOrderTypes[j] == orderType) playListContent += musicPlayListStr(newNode);       
                                }
                            }    

                            content += '<div id = "' + category_index + '_' + category + '"><hr>\
                                            <i class="fas fa-plus-square" style = "cursor:pointer" name = "' + category_index + '_' + category + '"></i>\
                                            <a href="#" contenteditable="' + isSelect + '" name = "'+ category_index  + '_' + category +'">' + newMusic.name + '</a>\
                                            <input type="checkbox" style="position: absolute; right: 20px; margin-top:5px; visibility:' + visible[isSelect] + '" value = "' + category_index + "-" + category + '">\
                                        </div>';
                           
                            checkboxes[i].parentElement.remove();
                            num++;
                            category_index++;
                              
                        }

                    }
                    if(playListContent != "") $(".playList").append(playListContent);
                    if(content != "") $("#myMusic_" + category).append(content);
                    
                }
            }
           

        })

        /* hide and display the music */
        $("body").on("click", ".musicCategoryTitle",function(){
            let name = $(this).attr("name");
            let display = $("#myMusic_" + name).css("display");
            if(display == "none")
            {
                $(this).children()[0].innerHTML = String.fromCharCode(9660);
                $("#myMusic_" + name).css("display","block");
            }
            else
            {
                $(this).children()[0].innerHTML = String.fromCharCode(9650);
                $("#myMusic_" + name).css("display","none");
            }      
        })

        /* play the music we click */
        $("body").on("click",".musicCategorySong div a",function(){
            
            /* we are in the edit mode */
            if(isSelect == true)
            {
                renameMusic = $(this);
                return;
            }

            let music = $(this).attr("name");
            let category = $(this).parents()[1].id;
            let index = parseInt(music);
            let oldIndex;
            let temp = playingMusicNode;


            /* change the icon of play/pause button */
            if($("#playPause").attr("name") == "pause")
            {   
                $("#playPause").text("");
                $("#playPause").attr("name","play");
                $("#playPauseText").text("pause");
                $("#playPause").append('<i class="fas fa-play"></i><span class = "shortcut"> space </span>');
            }   
            if(playingMusicNode != null)
            {
                $("#playList_" + playingMusicNode.val.index).css("color","");
                $("#" + playingMusicNode.val.musicIndex  + "_" + playingMusicNode.val.category).css("color","");
                oldIndex = playingMusicNode.val.index;
            }

            
            category = category.substr(category.indexOf('_') + 1);
            
            /* find the associated node in the playList */
            playingMusicNode = findMusicOfList(musicDict[category][index], myMusicCategory, orderType, musicNodePointers);
            
            /* we didn't find associated node and we click the song belons to another category */
            if(myMusicCategory != category && playingMusicNode == null) 
            {   
               
                myMusicCategory = category;
                showMusicList();
                playingMusicNode = findMusicOfList(musicDict[category][index], myMusicCategory, orderType, musicNodePointers);

                /* it gets deleted before */
                if(playingMusicNode == null)
                {
                    playingMusicNode = musicListDict[myMusicCategory][orderType].push_front(musicDict[category][index].deepCopy(myMusicCategory));
                   
                    playingMusicNode.val.index = musicNodePointers.length;
                    playingMusicNode.val.orderType = orderType;
                    musicDict[category][index].listIndices.push(musicNodePointers.length);
                    musicNodePointers.push(playingMusicNode);
                    $(musicPlayListStr(playingMusicNode)).insertAfter("#playListTitle");
                }
                
            }
            /* 
                we just didn't find the associated node which belongs to current category(it indicares we delete this music from our playList before). We add this music back to playList.
            */
            else if(playingMusicNode == null)
            {
                playingMusicNode = musicListDict[category][orderType].insert_after(musicNodePointers[oldIndex],musicDict[category][index].deepCopy(myMusicCategory));

                musicDict[category][index].listIndices.push(musicNodePointers.length);
                playingMusicNode.val.index = musicNodePointers.length;
                playingMusicNode.val.orderType = orderType;
                musicNodePointers.push(playingMusicNode);
               
                
                $(musicPlayListStr(playingMusicNode)).insertAfter("#playList_" + oldIndex);
            }


            playingMusic.pause();
            playingMusic.src = playingMusicNode.val.src;
            playingMusic.play();
        })

        $("body").on('click',".musicCategorySong div i", function(){
            let music = $(this).attr("name");
            let category = $(this).parents()[1].id;
            let index = parseInt(music);
            let newNode;
            let content;
            category = category.substr(category.indexOf('_') + 1);
            
            /* insert the new node to the play list */
            newNode = musicListDict[myMusicCategory][orderType].insert_after(playingMusicNode, musicDict[category][index].deepCopy(myMusicCategory));
            
            musicDict[category][index].listIndices.push(musicNodePointers.length);
            newNode.val.index = musicNodePointers.length;
            newNode.val.orderType = orderType;
            musicNodePointers.push(newNode);

            content = musicPlayListStr(newNode);
            $(content).insertAfter("#playList_" + playingMusicNode.val.index);
       
        })

        /* update the musicCurrentTime */
        playingMusic.addEventListener("timeupdate",function(){
            let time = parseInt(playingMusic.currentTime);
            
            let percent;
            if(myMusicCurrentTime != time)
            {
                myMusicCurrentTime = time;
                $(".musicCurrentTime").text(secondsToTimeString(time));
                percent = time / myMusicDuration * 100;
                $(".musicSlider").val(time);
            
                $(".musicSlider").css( 'background', 'linear-gradient(to right, green 0%, green '+ percent +'%, #fff ' + percent + '%100%)' )
            }
        })

        /* when loading a new music, I reset the min, max, val of range, musicCurrentTime,playingSongName and musicDuration */
        playingMusic.addEventListener("loadedmetadata",function(){
            

            let timeStr = secondsToTimeString(playingMusic.duration);
            myMusicCurrentTime = -1;
            myMusicDuration = parseInt(playingMusic.duration);

            $("#playList_" + playingMusicNode.val.index).css("color","blue");
           
            $("#" + playingMusicNode.val.musicIndex  + "_" + playingMusicNode.val.category).css("color","blue");

            $(".musicSlider").val(0);
            $(".musicSlider").attr("min", 0);
            $(".musicSlider").attr("max",myMusicDuration);
            $(".playingSongName").text(playingMusicNode.val.name);
            
            $(".musicCurrentTime").text("0:00");
            $(".musicDuration").text(timeStr);
        })

        /* the music ends and play the next song */
        playingMusic.addEventListener("ended",function(){
           
            console.log("ended");
            $("#playList_" + playingMusicNode.val.index).css("color","");
            $("#" + playingMusicNode.val.musicIndex  + "_" + playingMusicNode.val.category).css("color","");
            if(orderType != 's') playingMusicNode = playingMusicNode.next;
            playingMusic.src = playingMusicNode.val.src;
            playingMusic.play();
        })



        /* sldie the music controler. So I update the currentTime and range track color */
        $(".musicSlider").on('input',function(){
            if(playingMusicNode == null) return;
            playingMusic.currentTime = this.value;
            let percent = (this.value / this.max) * 100;
            $(this).css( 'background', 'linear-gradient(to right, green 0%, green '+ percent +'%, #fff ' + percent + '%100%)' )
        })

        $(".volumeSlider").on('input',function(){
            let percent = (this.value / this.max) * 100;
            let type = $(this)[0].name;
            playingMusic.volume = this.value;

            if(type == "mute")
            {
                $(this)[0].name = "on";
                $("#volume").text("");
                $("#volume").append('<i class="fas fa-volume-up"></i><span class = "shortcut"> ctr-m/alt-m </span>');
            }
            $(this).css( 'background', 'linear-gradient(to right, green 0%, green '+ percent +'%, #fff ' + percent + '%100%)' )
        })

        /* check all checkboxes under a certain category */
        $("[type='checkbox']").click(function(event){
            let name = $(this).attr("name");
            let checked;
            if(name != undefined)
            {   
                checked = $(this).prop("checked");
                $("#" + name + " [type='checkbox']").prop("checked",checked);
                event.stopPropagation();
            }
        })

        

        musicThread.on("MUSIC_DELETION",function(){
            let checkboxes = $("[type='checkbox']");
            let name,value;
            let files;
            let index;
            let category;
            let node;
            let isReload = false;
            for(var i = 0; i < checkboxes.length; i++)
            {
               
                if(checkboxes[i].checked)
                {
                    if(checkboxes[i].value == "")
                    {

                        name = checkboxes[i].name;
                        name = name.substr(8); // the first 8 letter is myMusic_
                        files = fs.readdirSync(path + name);
                        if(files.length == 0) 
                        {
                            fs.rmdirSync(path + name);
                            checkboxes[i].parentElement.parentElement.remove();
                            $("#myMusic_" + name).remove();
                            delete musicDict[name];
                        }
                    }
                    else
                    {   

                        value = checkboxes[i].value;

                        value = value.split('-');
                        category = value[1];
                        index = parseInt(value[0]);
                        checkboxes[i].parentElement.remove();
                        musicDict[category][index].isdelete = true;
                        /* delete the associated musics in the playlist*/
                        for(var j = 0; j < musicDict[category][index].listIndices.length; j++)
                        {
                            node = musicNodePointers[musicDict[category][index].listIndices[j]];
                            if(playingMusicNode == node) 
                            {
                                if(playingMusicNode.next == playingMusicNode) playingMusicNode = null;
                                else playingMusicNode = playingMusicNode.next;

                                isReload = true;
                            }
                            musicListDict[node.val.playListCategory][node.val.orderType].erase(node);
                           
                            if(node.val.playListCategory == myMusicCategory)
                            {
                                $("#playList_" + node.val.index).remove();
                            }
                        }
                        fs.unlinkSync(musicDict[category][index].filePath);
                    }
                }
            }
            if(isReload == true)
            {
                playingMusic.pause();
                if(playingMusicNode != null) 
                {
                    playingMusic.src = playingMusicNode.val.src;
                    playingMusic.play();
                }
                else
                {
                    $(".musicSlider").val(0);
                    $(".musicSlider").attr("min", 0);
                    $(".musicSlider").attr("max",0);
                    $(".playingSongName").text("");
                    $(".musicCurrentTime").text("0:00");
                    $(".musicDuration").text("0:00");
                }
            }
        })


        /* add the musics we uploaded to the category and playList */
        musicThread.on("doneUpload",function(event,files){
            let category = $("#chosenCategory").text();
            let category_index = musicDict[category].length;
            let content = "";
            let playListContent = "";
            let type;
            let newNode;

            for(var i = category_index; i < files.length + category_index; i++)
            {
                newMusic = new Music(path + category + '/' + files[i - category_index],files[i - category_index], category);
                newMusic.musicIndex = i;
                musicDict[category].push(newMusic);

                for(var j = 0; j < playOrderTypes.length; j++)
                {
                    if(playOrderTypes[j] != "s" && musicListDict[category][playOrderTypes[j]] != null)
                    {
                        newNode = musicListDict[category][playOrderTypes[j]].push_back(newMusic.deepCopy());
                        musicDict[category][i].listIndices.push(musicNodePointers.length);
                        newNode.val.index = musicNodePointers.length;
                        newNode.val.orderType = playOrderTypes[j];
                        musicNodePointers.push(newNode);
                       
                        if(myMusicCategory == category && playOrderTypes[j] == orderType) playListContent += musicPlayListStr(newNode);       
                    }
                }           

                content += '<div id = "' + i + '_' + category + '"><hr>\
                                <i class="fas fa-plus-square" style = "cursor:pointer" name = "' + i + '_' + category + '"></i>\
                                <a href="#" contenteditable="' + isSelect + '" name = "'+ i + '_' + category +'">' + newMusic.name + '</a>\
                                <input type="checkbox" style="position: absolute; right: 20px; margin-top:5px; visibility:' + visible[isSelect] + '" value = "' + i + "-" + category + '">\
                            </div>';
            }
            if(playListContent != "") $(".playList").append(playListContent);
            if(content != "") $("#myMusic_" + category).append(content);
            
        })

        

        /* rename */
        $('body').on('blur',".musicCategorySong div a",function(){
            
            if(isSelect == false || renameMusic == null) return;

            let music = renameMusic.attr("name");
            let category = renameMusic.parents()[1].id;
            let index = parseInt(music);
            let newMusic;
            let node;
            let newName;

            category = category.substr(category.indexOf('_') + 1);

            /* when we want to name it with empty string, we restore it to original name */
            if($(this).text() == "") 
            {
                $(this).text(musicDict[category][index].name);
                return;
            }
            
            /* rename it and update the associated node in the list */
            newName = parseInt(musicDict[category][index].fileName) + "-" + $(this).text();
            newMusic = new Music(path + category + '/' + newName, newName, category);

            fs.renameSync(musicDict[category][index].filePath, path + category + "/" + newName);
            updateMusicFromList(musicDict[category][index], newMusic, musicNodePointers);
            
            /* uodate the playList interface  */ 
            for(var i = 0; i < musicDict[category][index].listIndices.length; i++)
            {

                node = musicNodePointers[musicDict[category][index].listIndices[i]];
                if(node.val.isdelete == false)
                {
                    /* we don't update the name of music which doesn't show so far.(it may be in the other type of music list) */
                    if(node.val.playListCategory == myMusicCategory && node.val.orderType == orderType) $("#playList_" + node.val.index).children()[0].innerHTML = node.val.name;
                }
            }
        })

        /* search */
        $("#search").keyup(function(){
            let searchVal = $(this).val();
            let music;
            let name;
            for(var key in musicDict)
            {
                for(var i = 0; i < musicDict[key].length; i++)
                {
                    music = musicDict[key][i];
                    if(music.isdelete == false)
                    {   
                        name = music.name;
                        if(case_sensitive == false) name = name.toLowerCase();
                        if(name.indexOf(searchVal) == -1) 
                        {
                            $("#" + music.musicIndex + "_" + music.category).css("display","none");
                        }
                        else
                        {
                            $("#" + music.musicIndex + "_" + music.category).css("display","block");
                            
                        }
                            
                    }
                }
            }
                
        })
        

        /* control button click events */
        $("#select").click(select);
        $("#upload").click(upload);
        $("#delete").click(deletion);
        $("#transfer").click(transfer);
        $("#order").click(order);
        $("#createCategoryWindow").click(createCategoryWindow);

        $("#next").click(next);
        $("#previous").click(previous);
        $("#playPause").click(playPause);
        $("#playList").click(playList);
        $("#volume").click(volume);

        /* control button shortcuts */
        $("body").keydown(function(event){
            if(event.ctrlKey || event.altKey)
            {
                switch(event.keyCode)
                {
                    case 88:            // 'x' key
                        select(); break;
                        
                    case 68:            // 'd' key
                        deletion(); break;
                    
                    case 67:            // 'c' key
                        createCategoryWindow(); break;

                    case 73:            // 'i' key
                        upload(); break;

                    case 84:            // 't' key
                        transfer(); break;

                    case 79:            // 'o' key
                        order(); break;

                    case 76:            // 'l' key
                        playList(); break;
                    
                    case 77:            // 'm' key
                        event.preventDefault();
                        volume(); break;

                }
            }
            else
            {
                switch(event.keyCode)
                {   
                    case 32:           // space key
                        event.preventDefault();
                        playPause(); break;
                    case 37:           // left arrow key
                        previous(); break;
                    case 39:           // right arrow key 
                        next(); break;
                    case 13:           // 'enter' key. I disable it.
                        event.preventDefault();
                        if(isSelect == true && renameMusic != null)renameMusic.blur();
                        break;
                }
            }
        })

        musicThread.on("changeCaseSensitive",function(event,newCaseSensitive){
                case_sensitive = (newCaseSensitive == "on");
        });
        musicThread.on("changeThemeMode",changeThemeMode);

})      
    </script>
    <script src = "../js/musicHTML.js"></script>
</html>