<!--
    music.html
    ChaoHui Zheng
    11/28/2019
-->

<!DOCTYPE html>
<html>
    <head>
        <title>Music Player</title>
        <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">
        <link href="../../fontawesome/css/all.css" rel="stylesheet">
        <style type="text/css">
        .topFeature
        {
            position: fixed;
            background-color: lightblue;
            height: 60px;
            width: 100%;
            z-index: 2;
        }

        .bottomFeature
        {
            position: fixed;
            background-color: lightblue;
            bottom: 0px;
            height: 60px;
            width: 100%;
            z-index: 2;
        }
        button
        {
            border: none;
            
            color:var(--text-color);
            background-color: var(--nav-color);
            
            margin-top: 5px;
            font-size: 20px;

        }
        button .shortcut, a .shortcut
        {
            font-size:17px;
            visibility: hidden;
            width: 90px;
            
            background-color: var(--page-background);
            color:var(--text-color);
            
            text-align: center;
            border-radius: 6px;
            position: absolute;
            bottom: 20%;
            left: -95%;
            z-index: 1;

        }
        button:hover .shortcut, a:hover .shortcut
        {
            visibility: visible;
        }
        
        button:focus
        {
            outline:none;
        }
        .playOrder
        {
            position: absolute;
            top:30px;
            left:53%;
            width:170px;
            height: 105px;
            border: 1px solid black;
           
            padding: 0px 0px 0px 0px;
            display: none;
            z-index: 2;
            background-color: red;
        }
        .create
        {
            position: fixed;
            top:40%;
            text-align: center;
            width: 80%;
            height: 20%;
            left:10%;
            border: 1px solid black;
            z-index: 2;
            background-color: red;
            display: none;
        }

        .importCategory
        {
            position: fixed;
            top:25%;
            text-align: center;
            width: 80%;
            height: 50%;
            left:10%;
            border: 1px solid black;
            z-index: 2;
            background-color: red;  
            display: none;
        }
        .categoryDropdown
        {
            font-size: 20px;  
            border: none;
            outline: none;
            padding: 7px 16px;
            background-color: blue;
            color: black;
            position: relative;
            text-align: left;
            margin-left: 5%;
            margin-right: 5%;
            margin-top: 5%;
            width: 90%;
            border-radius: 13px;

        }
        .categoryDropdown:focus
        {
            outline:none;
        }

        .categoryContent
        {   
            transition: 0.5s;
            position: absolute;
            margin-left: 5%;
            width: 90%;
            background-color: blue;
            box-shadow: 0px 4px 8px 0px;
            height: 100
            z-index: 2;
            max-height: 0%;
            overflow: scroll;
            border-radius: 10px;
            
        }
        .categoryContent a 
        {

            color:black;
            padding: 7px 16px;
            text-decoration: none;
            display: block;
            text-align: left;

        }
        .categoryContent a:hover
        {
            background-color: pink;
        }
        hr
        {
            background-color: black;
            margin: -1px 0px 0px 0px;
        }
        .musicContent
        {
            position: fixed;
            overflow: scroll;
            top: 70px;
            bottom: 70px;
            width: 100%;
            border: 1px solid red;
        }

      
        .musicCategoryTitle
        {
           position: absolute;
           width: 100%;
           padding-left: 20px;
          
                  
           cursor: pointer;
           background-color: lightblue;
           z-index: 2;
        }
        .musicCategorySong
        {   
            margin-left: 20px;
        }
        .musicCategorySong a
        {
            cursor: pointer;
            margin-left: 17px;
            margin-right: 30px;
            /*
            position: absolute;
            left: 70px;
            overflow: hidden;
            */
           
        }
        .volumeController
        {
            color:blue;
            position:absolute; 
             left: 41%; 
            margin-top: 15px; 
            display: block;
        }
        a:hover
        {
            text-decoration: none;
        }


        .volumeSlider
        {
            -webkit-appearance: none;
            background: linear-gradient(to right, green 0%, green 50%, #fff 50%, #fff 100%);
            border: solid 1px #00b300;
            border-radius: 8px;
            height: 7px;
            width: 10%;
            outline: none; 
            left: 38.5%; 
            margin-top: 40px; 
            position: absolute;
            transition: background 450ms ease-in;
        }

        .musicSlider
        {
            -webkit-appearance: none;
            border: solid 1px #00b300;
            border-radius: 8px;
            height: 7px;
            width: 27%;
            outline: none; 
            left: 6%; 
            margin-top: 20px; 
            position: absolute;
        }
        .musicCurrentTime
        {
            width: 5%;
            text-align: right;
            margin-top: 10px; 
            position: absolute;

        }
        .musicDuration
        {
            width: 5%;
            text-align: left;
            margin-top: 10px; 
            position: absolute;
            left:34%;

        }
        .playingSongName
        {
            text-align: left;
            margin-top: 35px; 
            position: absolute;
            left:6%;
        }


        
    </style>
    </head>

    <body>

        <div class = "topFeature">
            <div style="position: relative">
            
                <input type="text" id = "search" style = "font-size: 18px;width: 40%;position: absolute;left: 15px;top:15px; border-radius: 5px"placeholder="Search ...">


                <button id = "delete" style = "position:absolute; left: 48%"> <i class="fas fa-trash"></i><span class = "shortcut"> ctr-i/alt-i </span></button>
                <button id = "transfer" style = "position:absolute; left: 57%"> <i class="fas fa-arrow-right"></i><span class = "shortcut"> ctr-i/alt-i </span></button>
                <button id = "order" style = "position:absolute; left: 66%"><i class="fas fa-long-arrow-alt-right"></i><span class = "shortcut"> ctr-i/alt-i </span></button>
                
                <button id = "upload" style = "position:absolute; left: 75%"><i class="fas fa-file-import"></i><span class = "shortcut"> ctr-i/alt-i </span></button>
                
                <button id = "createCategoryWindow" style = "position:absolute; left: 84%"> <i class="fas fa-plus"></i><span class = "shortcut"> ctr-i/alt-i </span></button>
                
                <button id = "select" style = "position:absolute; left: 93%"><i class="fas fa-mouse-pointer"></i><span class = "shortcut"> ctr-x/alt-x </span></button>
                 <span style="position: absolute; left: 47.3%; margin-top: 35px;">delete</span>
                  <span style="position: absolute; left: 55.8%; margin-top: 35px;">transfer</span>
                <span style="position: absolute; left: 65.9%; margin-top: 35px;">order</span>
                <span style="position: absolute; left: 74.4%; margin-top: 35px;">import</span>
                <span style="position: absolute; left: 83.4%; margin-top: 35px;">create</span>
                <span style="position: absolute; left: 92.2%; margin-top: 35px;">select</span>
               
               
               
            </div>
        </div>
       
        <div class="bottomFeature">
            <div>
                <span class="playingSongName">123</span>
               
                <span class="musicCurrentTime">0:12</span>

                <input type="range" min="0" max="11" value="0" step="1" class = "musicSlider" id = "musicSlider">
                <span class="musicDuration">1:00</span>
                
                <button id = "volume" class = "volume" style = "position:absolute; left: 41%"> <i class="fas fa-volume-up"></i><span class = "shortcut"> ctr-i/alt-i </span></button>
                

                <input type="range" class = "volumeSlider"  id="start" name="volume" min="0.0" max="1.0" value = '0.5' step = 0.01>
                
                <button id = "previous" style = "position:absolute; left: 53%"><i class="fas fa-step-backward"></i><span class = "shortcut"> ctr-i/alt-i </span></button>
                
                <button id = "playPause" style = "position:absolute; left: 65%"> <i class="fas fa-play"></i><span class = "shortcut"> ctr-i/alt-i </span></button>
                
                <button id = "next" style = "position:absolute; left: 77%"> <i class="fas fa-step-forward"></i><span class = "shortcut"> ctr-i/alt-i </span></button>
                
                <button id = "playList" style = "position:absolute; left: 89%" name = "pause"> <i class="fas fa-list"></i><span class = "shortcut"> space </span></button>
                

                <span style="position: absolute; left: 51.7%; margin-top: 35px;">previous</span>
                <span style="position: absolute; left: 65.2%; margin-top: 35px;">play</span>
                <span style="position: absolute; left: 77%; margin-top: 35px;">next</span>
                <span style="position: absolute; left: 88.3%; margin-top: 35px;">play list</span>    
            </div>
        </div>
        <!-- play order chooser -->
        <div class = "playOrder">
            <span id = "inOrder" style=" position: relative; left: 20px; top: 5px; cursor: pointer;"><i class="fas fa-long-arrow-alt-right"></i>&emsp;in order&emsp;<i class="fas fa-check" style="visibility: hidden;"></i></span>
            <hr style="margin: 10px 0px 5px 0px;">
             <span id = "random" style=" position: relative; left: 20px; cursor: pointer; "><i class="fas fa-random"></i>&emsp;random&emsp;<i class="fas fa-check" style="visibility: hidden;"></i></span>
            <hr style="margin: 5px 0px 5px 0px;">
            <span id = "single" style=" width: 100%; position: relative; left: 20px; cursor: pointer;"> <i class="fas fa-recycle"></i></i>&emsp;single&emsp;&ensp;&nbsp;<i class="fas fa-check" style="visibility: hidden;"></i></span>

        </div>

        <!-- create a new album -->
        <div class="create">
           
            <input type="text" id = "categoryName" class="form-control" placeholder="Enter category name" style="width: 90%; margin-left: 5%; margin-top: 1%;">

            <div style="text-align: right; margin-right: 5%; margin-top: 3%;">
                <button id = "cancelCategory" type="button" class="btn btn-primary">Cancel</button>
                &nbsp;&nbsp;
                <button id = "createCategory" type="button" class="btn btn-danger">Create</button>
            </div>
        </div>

        <!-- choose the category to import -->
        <div class="importCategory">
            <button class = "categoryDropdown" type="button"><span id = "chosenCategory">Import to ...</span><i class="fa fa-caret-down" style="position:absolute; left:90%; font-size: 30px"></i></button>
            <div class = "categoryContent"> 
            </div>
            
            <div style="text-align: right; position: relative; right: 5%; top: 55%;">
                <button id = "cancelImportTransfer" type="button" class="btn btn-primary" style="width: 100px">Cancel</button>
                &nbsp;&nbsp;
                <button id = "yesImportTransfer" type="button" class="btn btn-danger" style="width: 100px">yes</button>
            </div>
        </div>

        <div id = "musicContent" class="musicContent">
            <div><span class = "musicCategoryTitle" name = "1"> 1 </span><span style="right: 30px; position: absolute;">▲</span>
               
                <div class = "musicCategorySong" id = "myMusic_1">
                    <br>
                    <i class="fas fa-plus-square"></i><a href="#" contenteditable="true">1232rfrienierfieofjewiohfiewnviowhfioewhioewfhfioewhfiowehfiowehfiowe hwoifheio hfiwoehfi owh fiow1</a><input type="checkbox" style="position: absolute; right: 20px">
                    <hr>
                    <i class="fas fa-plus-square"></i><a href="#" style="position: absolute;">2435</a><input type="checkbox" style="position: absolute; right: 20px">

                </div>
            </div>
            <div><span class = "musicCategoryTitle">Category▲</span>
                <div class = "musicCategorySong">
                    <br>
                    <i class="fas fa-plus-square"></i><a href="#" contenteditable="true">1</a>
                    <hr>

                    <i class="fas fa-plus-square"></i><a href="#">2</a>

                </div>
            </div>
        </div>

    </body>
    <script type="text/javascript">
        const $ = require("jQuery");
        const remote = require('electron').remote;
        const musicThread = require('electron').ipcRenderer;
        const {Confirmation} = require("../js/confirmation.js");
        const fs = require("fs");
        const user = remote.getGlobal('share').user;  
        const path = "./data/" + user + "/music/";
        const {Music,secondsToTimeString} = require("../js/music.js")

        var playOrder = null; 
        var playingMusic = new Audio();
        playingMusic.volume = 0.5;
        var musicDict = {};
        var newMusic;
        var myMusicIndex;
        var myMusicCategory;
        var myMusicCurrentTime = -1;
        var myMusicDuration = 0;
        var visible = {false:"hidden",true:"visible"};
        var isSelect = false;
        var typeTransferImport = "";
        //const {changeThemeMode, loadThemeMode} = require("../js/theme.js");
        //loadThemeMode();



        function showMusic()
        {
            var dirs = fs.readdirSync(path);

            var files;
            var content = "";
            for(var i = 0; i < dirs.length; i++)
            {
                files = fs.readdirSync(path + dirs[i]);
                files = files.sort(function(m1,m2){return parseInt(m1) - parseInt(m2);});
                musicDict[dirs[i]] = [];
                content += '<div style = "margin-top:5px">\
                                <div class = "musicCategoryTitle" name = "' + dirs[i] + '">' + dirs[i] + '\
                                    <span style="right: 60px; position: absolute; cursor:pointer">▲</span>\
                                    <input type="checkbox" style="position: absolute; right: 20px; margin-top:5px; visibility:hidden" value = "" name = "myMusic_' + dirs[i] + '">\
                                </div>\
                                <br>\
                            </div>\
                            <div class = "musicCategorySong" id = "myMusic_' + dirs[i] + '">';
                for(var j = 0; j < files.length; j++)
                {
                    newMusic = new Music(path + dirs[i] + '/' + files[j],files[j]);
                    musicDict[dirs[i]].push(newMusic);
                    console.log(files[j]);
                    content += '<div><hr>\
                                    <i class="fas fa-plus-square"></i>\
                                    <a href="#" contenteditable="true" name = "'+ j  + '_' + dirs[i] +'">' + newMusic.name + '</a>\
                                    <input type="checkbox" style="position: absolute; right: 20px; margin-top:5px; visibility:hidden" value = "' + j + "-" + dirs[i] + '">\
                                </div>';
                    //if(j != files.length - 1) content += '<hr></div>';
                    //else content += '</div>'
                }
                content += "</div>"
            }
            $("#musicContent").text("");
            $("#musicContent").append(content);

        }
       showMusic();

        /* play order */
        $(".playOrder span").click(function(){
           
            if(playOrder != null) 
            {
                playOrder.css("color","");
                playOrder.children()[1].style.visibility = "hidden";
            }

            playOrder = $(this);
           
            $("#order").text("");
            $("#order").append(playOrder.children()[0].outerHTML + '<span class = "shortcut"> ctr-i/alt-i </span>');
            $(".playOrder").css("display","none");
        })
        $("#order").click(function(){
            $(".playOrder").css("display","block");
        })


        /* create the new category */
        $("#createCategoryWindow").click(function(){
            $(".create").css("display","block");
        })
        $("#createCategory").click(function(){
            /* remove the trailing space */
            var dir = path + $("#categoryName").val().replace(/\s+$/,"");
            /* check if the album exists */
            if(fs.existsSync(dir) === true) musicThread.send("errorMessage","ERROR","The album exists");
            else 
            {
                fs.mkdirSync(dir);
                $(".create").css("display","none");
            }
           
        })
        $("#cancelCategory").click(function(){
             $(".create").css("display","none");
        })

        /* import the music */
        $("#upload").click(function(){
            typeTransferImport = "import";
            $("#chosenCategory").text("Import to ...");
            $(".importCategory").css("display","block");
        })

        $(".categoryDropdown").click(function(){
            let max_height = $(".categoryContent").css("max-height");
            let dirs;
            let content = "";
            console.log(max_height);
            if(max_height == "0%")
            {
                dirs = fs.readdirSync(path);
                for(var i = 0; i < dirs.length; i++) content += '<a href = "#">' + dirs[i] + '</a>';
                $(".categoryContent").text(""); 
                $(".categoryContent").append(content);
                $(".categoryContent").css("max-height","50%");
            }
            else $(".categoryContent").css("max-height","0%");
        })

        $('body').on("click",".categoryContent a",function(){
            $("#chosenCategory").text($(this).text());    
            $(".categoryContent").css("max-height","0%");
        })

        $("#cancelImportTransfer").click(function(){
             $(".importCategory").css("display","none");
        })

        $("#yesImportTransfer").click(function(){
            let category = $("#chosenCategory").text();
            let checkboxes;
            let value,index;
            let from,to;
            let content = "";
            let category_index;
            let newFileName;
            if(typeTransferImport == "import")
            {
                if(category == "Import to ...") musicThread.send("errorMessage","ERROR","Select one category");
                else
                {
                    $(".importCategory").css("display","none");
                    musicThread.send("upload","music/" + category + "/");
                }
            }
            else
            {
                if(category == "Transfer to ...") musicThread.send("errorMessage","ERROR","Select one category");
                else
                {
                    $(".importCategory").css("display","none");
                    checkboxes = $("[type='checkbox']");
                    to = path + category + "/";
                    
                    category_index = musicDict[category].length;
                    
                    
                    var files = fs.readdirSync(to).sort(function(t1,t2){return parseInt(t1) - parseInt(t2);});
                    
                    /* name our files with number. Therefore, we can have multiple same files */
                    if(files.length == 0) num = 1;
                    /* grab the biggest number */
                    else num =  1 + parseInt(files[files.length - 1]);
                    


                    for(var i = 0; i < checkboxes.length; i++)
                    {
                        
                        if(checkboxes[i].value != "" && checkboxes[i].checked)
                        {

                            value = checkboxes[i].value;
                            value = value.split('-');
                            index = parseInt(value[0]);

                            from = musicDict[value[1]][index].filePath;
                            newFileName = num + "-" + musicDict[value[1]][index].name;
                            

                            fs.renameSync(from, to + newFileName);
                            newMusic = new Music(to + newFileName, newFileName);
                            musicDict[category].push(newMusic);
                            

                            content += '<div><hr>\
                                    <i class="fas fa-plus-square"></i>\
                                    <a href="#" contenteditable="true" name = "'+ category_index  + '_' + category +'">' + newMusic.name + '</a>\
                                    <input type="checkbox" style="position: absolute; right: 20px; margin-top:5px; visibility:' + visible[isSelect] + '" value = "' + category_index + "-" + category + '"></div>';
                           
                            checkboxes[i].parentElement.remove();
                            num++;
                            category_index++;
                              
                        }

                    }
                    
                    if(content != "") $("#myMusic_" + category).append(content);
                    
                }
            }
        })

        /* hide and display the music */
        $("body").on("click", ".musicCategoryTitle",function(){
            let name = $(this).attr("name");
            let display = $("#myMusic_" + name).css("display");
            if(display == "none")
            {
                $(this).children()[0].innerHTML = String.fromCharCode(9660);
                $("#myMusic_" + name).css("display","block");
            }
            else
            {
                $(this).children()[0].innerHTML = String.fromCharCode(9650);
                $("#myMusic_" + name).css("display","none");
            }      
        })

        /* play and pause the music */
        $("#playPause").click(function(){
            type = $(this).attr("name");
            $(this).text("");
            if(type == "pause")
            {
                $(this).attr("name","play");
                $(this).append('<i class="fas fa-play"></i><span class = "shortcut"> space </span>');
                playingMusic.play();
            }
            else
            {
                $(this).attr("name","pause");
                $(this).append('<i class="fas fa-pause"></i><span class = "shortcut"> space </span>');
                playingMusic.pause();
            }
        })


        /* play the music we click */
        $("body").on("click",".musicCategorySong div a",function(){
            let music = $(this).attr("name");
            let category = $(this).parents()[1].id;
            let index = parseInt(music);
           

            category = category.substr(category.indexOf('_') + 1);
            playingMusic.pause();
            playingMusic.src = musicDict[category][index].src;
            playingMusic.play();
            myMusicIndex = index;
            myMusicCategory = category;
           
        })

        /* update the musicCurrentTime */
        playingMusic.addEventListener("timeupdate",function(){
            let time = parseInt(playingMusic.currentTime);
            
            let percent;
            if(myMusicCurrentTime != time)
            {
                myMusicCurrentTime = time;
                $(".musicCurrentTime").text(secondsToTimeString(time));
                percent = time / myMusicDuration * 100;
                $(".musicSlider").val(time);
                //console.log(percent);
                $(".musicSlider").css( 'background', 'linear-gradient(to right, green 0%, green '+ percent +'%, #fff ' + percent + '%100%)' )
            }
        })

        /* when loading a new music, I reset the min, max, val of range, musicCurrentTime,playingSongName and musicDuration */
        playingMusic.addEventListener("loadedmetadata",function(){
            //console.log(playingMusic.duration);
            let timeStr = secondsToTimeString(playingMusic.duration);
            myMusicCurrentTime = -1;
            myMusicDuration = parseInt(playingMusic.duration);
            $(".musicSlider").val(0);
            $(".musicSlider").attr("min", 0);
            $(".musicSlider").attr("max",myMusicDuration);
            $(".playingSongName").text(musicDict[myMusicCategory][myMusicIndex].name);
            //console.log($(".musicSlider").attr("value"));
            
            $(".musicCurrentTime").text("0:00");
            $(".musicDuration").text(timeStr);
        })

        /* the music ends and play the next song */
        playingMusic.addEventListener("ended",function(){
            console.log("ended");
            myMusicIndex = (myMusicIndex + 1) % musicDict[myMusicCategory].length;
            playingMusic.src = musicDict[myMusicCategory][myMusicIndex].src;
            console.log(playingMusic.src);
            playingMusic.play();
        })



        /* sldie the music controler. So I update the currentTime and range track color */
        $(".musicSlider").on('input',function(){
            playingMusic.currentTime = this.value;
            let percent = (this.value / this.max) * 100;
            $(this).css( 'background', 'linear-gradient(to right, green 0%, green '+ percent +'%, #fff ' + percent + '%100%)' )
        })

        $(".volumeSlider").on('input',function(){
            let percent = (this.value / this.max) * 100;
            playingMusic.volume = this.value;

            $(this).css( 'background', 'linear-gradient(to right, green 0%, green '+ percent +'%, #fff ' + percent + '%100%)' )
        })



        /* hide/display checkbox */
        $("#select").click(function(event){
            isSelect = !isSelect;
            $("[type='checkbox']").css("visibility",visible[isSelect]);
            
        })

        /* check all checkboxes under a certain category */
        $("[type='checkbox']").click(function(event){
            let name = $(this).attr("name");
            let checked;
            if(name != undefined)
            {   
                checked = $(this).prop("checked");
                $("#" + name + " [type='checkbox']").prop("checked",checked);
                event.stopPropagation();
            }
        })

        /* delete the music */
        $("#delete").click(function(){
            var confirmation = new Confirmation(
                "MUSIC_DELETION",     //type
                "Delete",             //title
                "Are you sure you want to delete the musics you selected?", // text
                ["Cancel","Delete"]   //buttonlabels 
            );
            musicThread.send("openConfirmation",confirmation);
        })

        musicThread.on("MUSIC_DELETION",function(){
            let checkboxes = $("[type='checkbox']");
            let name,value;
            let files;
            let index;
            let category;
            console.log(checkboxes[0]);
            for(var i = 0; i < checkboxes.length; i++)
            {
               
                if(checkboxes[i].checked)
                {
                    if(checkboxes[i].value == "")
                    {

                        name = checkboxes[i].name;
                        name = name.substr(8); // the first 8 letter is myMusic_
                        files = fs.readdirSync(path + name);
                        if(files.length == 0) 
                        {
                            fs.rmdirSync(path + name);
                            checkboxes[i].parentElement.parentElement.remove();
                            $("#myMusic_" + name).remove();

                        }
                    }
                    else
                    {   
                        value = checkboxes[i].value;
                        value = value.split('-');
                        category = value[1];
                        index = parseInt(value[0]);
                        checkboxes[i].parentElement.remove();
                        fs.unlinkSync(musicDict[category][index].filePath);
                    }
                }
            }
        })


        $("#transfer").click(function(){
            typeTransferImport = "transfer";
            $("#chosenCategory").text("Transfer to ...");
            $(".importCategory").css("display","block");
        })
        /* disable 'enter' key when typing title */
        $("body").keydown(function(event){
            if (event.which == '13') 
            {
                event.preventDefault();
                $("a").blur();
            }
        })


       
        
    </script>
</html>