<!--
    music.html
    Hunter Leef
    10/28/19
    This is currently functioning music player
-->

<!DOCTYPE html>
<html>
    <head>
        <title>Music Player</title>
        <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">
        <link href="../../fontawesome/css/all.css" rel="stylesheet">
        <style type="text/css">
            body
            {
                background-color: var(--background-color);
                color: var(--text-color);
            }
            h1, h2, h3{
                text-align: center;
                font-size: 22px;
            }
            label, p{
                font-size: 15px;
            }
            div{
                margin-bottom: 5px;
            }
            div:last-of-type{
                margin-bottom: 0px;
            }
            hr{
                width: 98%;
                height: 3px;
                background-color: rgb(34, 34, 34);
                clear: both;
            }
            .button_container{
                text-align: center;
            }
            .upbutton{
                background-color: whitesmoke;
                color: black;
                border: 2px solid rgb(41, 172, 224);
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                border-radius: 8px;
            }
            .upbutton:hover{
                background-color: rgb(41, 172, 224);
                color: whitesmoke;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                border-radius: 8px;
            }
            .delbutton{
                background-color: whitesmoke;
                color: black;
                border: 2px solid maroon;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                border-radius: 8px;
            }
            .delbutton:hover{
                background-color: maroon;
                color: whitesmoke;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                border-radius: 8px;
            }
            .pbutton{
                background-color: forestgreen;
                color: whitesmoke;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                padding: 8px;
                border-radius: 50%;
            }
            .tbutton{
                background-color: #EFEFF0;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 12px;
                border-radius: 35%;
                border: transparent;
            }
            .light_button{
                background-color: #EFEFF0;
                color: #1F1F1F;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 10px;
                padding: 4px;
                border-radius: 15%;
            }
            .dark_button{
                background-color: #1F1F1F;
                color: #EFEFF0;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 10px;
                padding: 4px;
                border-radius: 15%;
            }
            .blue_button{
                background-color: #5FD0FE;
                color: #EFEFF0;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 10px;
                padding: 4px;
                border-radius: 15%;
            }
            .side_by_side{
                width: 100%;
                margin: auto;
            }
            .volume_container{
                width: 50%;
                text-align: center;
                float: left;
            }
            .vol_slider{
                -webkit-appearance: none;
                width: 70%;
                height: 5px;
                background: #d3d3d3;
                outline: none;
                opacity: 0.65;
                -webkit-transition: .2s;
                transition: opacity .2s;
            }
            .vol_slider:hover{
                opacity: 1;
            }
            .vol_slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 10px;
                height: 10px;
                background: rgb(87, 67, 201);
                cursor: pointer;
            }
            .vol_slider::-moz-range-thumb {
                width: 10px;
                height: 10px;
                background: rgb(87, 67, 201);
                cursor: pointer;
            }
            .second_select{
                width: 50%;
                float: left;
                text-align: center;
            }
            .timer_container{
                text-align: center;
                width: 100%;
            }
            .light_grey{
                background-color: rgb(189, 189, 189);
                height: 12px;
                width: 75%;
                display: inline-block;
            }
            .light_blue{
                background-color: rgb(64, 151, 206);
            }
        </style>
    </head>

    <body>
        <div class= "container">
            <hr>
            <h3>Controls</h3>
            <div class="button_container">
                <button id = "upload" type="button" class="upbutton">Upload Music</button>
                &nbsp;&nbsp;
                <button id = "delete" type="button" class="delbutton">Delete Selected Music</button>
                &nbsp;&nbsp;
                <button id = "refresh" type="button" class="upbutton">Refresh Playlist</button>
            </div>
            <div class="button_container">
                <button id = "prev" type="button" class="tbutton" title="go to previous song"><img src="../../image/prev.png"></button>
                &nbsp;
                <button id = "rewind" type="button" class="tbutton" title="rewind"><img src="../../image/rewind_button.png" alt="rewind"></button>
                &nbsp;
                <button id = "play" type="button" class="tbutton" title="play/pause"><img src="../../image/play_button.png" alt="play"></button>
                &nbsp;
                <button id = "playRand" type="button" class="tbutton" title="play random"><img src="../../image/shuffle_button.png" alt="random"></button>
                &nbsp;
                <button id = "fastForward" type="button" class="tbutton" title="fast forward"><img src="../../image/fast_forward.png" alt="forward"></button>
                &nbsp;
                <button id = "next" type="button" class="tbutton" title="go to next song"><img src="../../image/skip.png"></button>  
            </div>
            <div class="side_by_side">
                <div class="second_select">
                    <p>FF/Rewind (secs)</p>
                    <form>
                        <label>5
                        <input type="radio" name="speed" id="speed1" value="5" checked></label>
                        <label>15
                        <input type="radio" name="speed" id="speed2" value="15"></label>
                        <label>30
                        <input type="radio" name="speed" id="speed3" value="30"></label>
                    </form>
                </div>
                <div class="volume_container">
                    <label>Volume Slide
                    <input type="range" min="0" max="100" value="100" class="vol_slider" id="vol_con">
                    </label>
                    <p><span id="vol_level"></span></p>
                </div>
            </div>
            <hr>
            <div>
                <h1>Currently Playing</h1>
                <div id="currently_playing"></div>
                <div class="timer_container">
                    <div class="light_grey">
                    <div id="prog_bar" class="light_blue" style="height:12px;width:0;">
                    </div>
                    </div>
                    <p><span id="curr_t_min"></span>:<span id="curr_t_sec"></span>/<span id="s_dur_min"></span>:<span id="s_dur_sec"></span></p>
                </div>
                <hr>
                <h2>Playlist (Check Box for Deletion)</h2>
                <div id="playlist"></div>
            </div>
        </div>
        <script type="text/javascript">
            const $ = require("jQuery");
            const fs = require("fs");
            const {changeThemeMode, loadThemeMode} = require("../js/theme.js");
            loadThemeMode();
            var musicThread = require('electron').ipcRenderer;
            var remote = require('electron').remote;  
            var user = remote.getGlobal('share').user;
            var audio_path = "";
            var audio = null;
            var music_list = [];
            var music_ind = 0;
            var music_titles_list = [];
            var attach = "";
            var data = "";
            var incr = 5;
            var dec = 5;
            var vol_slider = document.getElementById("vol_con");
            var curr_vol = document.getElementById("vol_level");
            var curr_t_min = document.getElementById("curr_t_min");
            var curr_t_sec = document.getElementById("curr_t_sec");
            var sec_chk = 0;
            var curr_dur_min = document.getElementById("s_dur_min");
            var curr_dur_sec = document.getElementById("s_dur_sec");
            var change_vol = 0;
            var p_bar_w = 1;
            var audio_tmp, tmp_ind;
            var aud_tmp_pl = false;

            curr_t_min.innerHTML = 0;
            curr_t_sec.innerHTML = '00';
            curr_dur_min.innerHTML = 0;
            curr_dur_sec.innerHTML = '00';

            curr_vol.innerHTML = vol_slider.value;
            // A function for displaying the currently uploaded music available for playback
            function showMusic(){
                music_list = [];
                music_titles_list = [];
                let previous_time = -1;
                $("#playlist").empty();
                path = "../../data/" + user + "/music/";
                fs.readdir("./data/" + user + "/music",(err,files) =>{
                    if(err) throw err;
                    var music_list_length = files.length;
                    for(var i = 0; i < music_list_length; i++) 
                    {
                        audio_path = path + files[i];
                        var slice = files[i].slice(0, files[i].length - 4);
                        audio = new Audio(audio_path);
                        // add the on time update event which will display the current time
                        // and duration of a song
                        audio.addEventListener('timeupdate', (event) => {
                            if(p_bar_w >= 100){
                                p_bar_w = 0;
                            }

                            else{
                                p_bar_w = parseInt((audio.currentTime / audio.duration)*100);
                                if(audio.currentTime < 10) {
                                        //curr_t_sec.innerHTML = "";
                                        //console.log(curr_t_sec)
                                        console.log((audio.currentTime).toFixed(0));
                                        curr_t_min.innerHTML = "0";
                                        $("#curr_t_sec").text('0' + (audio.currentTime).toFixed(0));  
                                        //curr_t_sec.innerHTML = '0' + (audio.currentTime).toFixed(0);
                                }
                                else if(audio.currentTime < 60) curr_t_sec.innerHTML = (audio.currentTime).toFixed(0);
                                else{
                                    curr_t_min.innerHTML = (audio.currentTime/60).toFixed(0);
                                    sec_chk = audio.currentTime%60;
                                    if(sec_chk < 10) curr_t_sec.innerHTML = '0' + sec_chk.toFixed(0);
                                    else curr_t_sec.innerHTML = sec_chk.toFixed(0);
                                }
                                document.getElementById("prog_bar").style.width = p_bar_w + '%';
                            }
                        });
                        if(i > 0){
                            music_list[i-1].onended = (event) => {
                                tmp_ind = (music_ind + 1)%music_list.length
                                audio_tmp = music_list[tmp_ind];
                                $("#currently_playing").empty();
                                $("#currently_playing").append(music_titles_list[tmp_ind]);
                                checkVol(audio_tmp);
                                checkDur(audio_tmp);
                                if(audio_tmp.currentTime < 60){
                                    curr_t_sec.innerHTML = (audio_tmp.currentTime).toFixed(0);
                                }
                                if(audio_tmp.currentTime < 10) {
                                    curr_t_min.innerHTML = "0";
                                    curr_t_sec.innerHTML = '0' + (audio_tmp.currentTime).toFixed(0);
                                }
                                else if(audio_tmp.currentTime < 60) curr_t_sec.innerHTML = (audio_tmp.currentTime).toFixed(0);
                                else{
                                    curr_t_min.innerHTML = (audio_tmp.currentTime/60).toFixed(0);
                                    sec_chk = audio_tmp.currentTime%60;
                                    if(sec_chk < 10) curr_t_sec.innerHTML = '0' + sec_chk.toFixed(0);
                                    else curr_t_sec.innerHTML = sec_chk.toFixed(0);
                                }
                                document.getElementById("prog_bar").style.width = 0 + '%';
                                aud_tmp_pl = true;
                                audio_tmp.play();
                            };
                        }
                        music_list.push(audio);
                        attach = "<body>" + "<b>" + slice + "</b>" + "</body>";
                        music_titles_list.push(attach);
                        // This creates a checkbox element
                        attach = "<label><input type=\"checkbox\" name=\"checkbox\" id = \"song" + i + "\">" + slice + "</label><br>";
                        $("#playlist").append(attach);
                    }
                    music_list_length = music_list.length;
                    music_ind = 0;
                    audio = music_list[music_ind];
                    p_bar_w = 1;
                })
            }
            // compare current song's volume with the selected slider volume
            // if they are different, change current song's volume to that of the slider's
            function checkVol(audio){
                change_vol = parseInt(vol_slider.value) / 100.00
                if(audio.volume !== change_vol) audio.volume = change_vol;
            }
            // volume adjustment func
            vol_slider.oninput = function(){
                curr_vol.innerHTML = this.value;
                if(audio !== null && audio === music_list[music_ind]){
                    audio.volume = parseInt(this.value) / 100.0;
                }
            }
            function checkDur(audio){
                if(audio.duration/60 !== curr_dur_min.innerHTML){
                    curr_dur_min.innerHTML = (audio.duration/60).toFixed(0);
                    sec_chk = audio.duration%60;
                    if(sec_chk < 10) curr_dur_sec.innerHTML = '0' + sec_chk.toFixed(0);
                    else curr_dur_sec.innerHTML = sec_chk.toFixed(0)
                }
            }
            function checkTmp(t_val){
                if(t_val){
                    music_ind = tmp_ind;
                    audio = audio_tmp;
                    aud_tmp_pl = false;
                }
            }
            $(document).ready(function(){


                musicThread.send("MUSIC_REGISTER");
                showMusic();
                music_list_length = music_list.length;
                // this will allow the user to upload music files (only mp3)
                $("#upload").click(function(){
                    musicThread.send("upload","music/");
                })
                // refresh button re-displays any of the uploaded music to the playlist
                $("#refresh").click(function(){
                    showMusic();
                })
                // play button will play the first song on the playlist, or if one was already playing
                // it will pause it and if clicked one additional time, re-play it
                $("#play").click(function(){
                    checkTmp(aud_tmp_pl);
                    if(audio !== null && audio.currentTime > 0 && !audio.paused){
                        $("#currently_playing").empty();
                        checkVol(audio);
                        checkDur(audio);
                        audio.pause();
                    }
                    else if(audio !== null && (audio.currentTime === 0 || audio.paused)){
                        $("#currently_playing").empty();
                        if(audio !== music_list[music_ind]) audio = music_list[music_ind];
                        $("#currently_playing").append(music_titles_list[music_ind]);
                        checkVol(audio);
                        checkDur(audio);
                        audio.play();
                    }
                })
                // find a "random" song from the playlist to play, it will ensure that the current song
                // is not repeated if there is one
                $("#playRand").click(function(){
                    var old_ind = music_ind;
                    checkTmp(aud_tmp_pl);
                    while(old_ind === music_ind){
                        music_ind = parseInt((Math.random() * music_list.length), 10);
                    }
                    if(audio !== null){
                        
                        audio.pause();
                        audio.currentTime = 0;
                    }
                    audio = music_list[music_ind];
                    $("#currently_playing").empty();
                    $("#currently_playing").append(music_titles_list[music_ind]);
                    checkVol(audio);
                    checkDur(audio);
                    audio.play();
                })
                // go forward within current song or skip to next song
                // depending on result from incrementing by time scale
                $("#fastForward").click(function(){
                    if(audio !== null){
                        checkTmp(aud_tmp_pl);
                        if(audio !== music_list[music_ind]) audio = music_list[music_ind];
                        if(!audio.paused) audio.pause;
                        if(!document.getElementById("speed1").checked){
                            if(document.getElementById("speed2").checked) incr = 15;
                            else incr = 30;
                        }
                        if((audio.currentTime + incr) < audio.duration) audio.currentTime += incr;
                        else{
                            audio.pause();
                            audio.currentTime = 0;
                            music_ind = (music_ind + 1) % music_list.length;
                            audio = music_list[music_ind];
                            p_bar_w = 1;
                            $("#currently_playing").empty();
                            $("#currently_playing").append(music_titles_list[music_ind]);
                            checkDur(audio);
                        }
                        checkVol(audio);
                        audio.play();
                    }
                })
                // Rewind by selected time scale
                // simply jump the song back by that scale (arithmetic)
                $("#rewind").click(function(){
                    if(audio !== null){
                        checkTmp(aud_tmp_pl);
                        if(audio !== music_list[music_ind]) audio = music_list[music_ind];
                        if(!audio.paused) audio.pause;
                        if(!document.getElementById("speed1").checked){
                            if(document.getElementById("speed2").checked) dec = 15;
                            else dec = 30;
                        }
                        if((audio.currentTime - dec) >= 0) audio.currentTime -= dec;
                        else{
                            p_bar_w = 1;
                            audio.pause();
                            audio.currentTime = 0;
                            music_ind -= 1;
                            if(music_ind < 0) music_ind = music_list.length - 1;
                            audio = music_list[music_ind];
                            $("#currently_playing").empty();
                            $("#currently_playing").append(music_titles_list[music_ind]);
                            checkDur(audio);
                        }
                        checkVol(audio);
                        audio.play();
                    }
                })
                // skip to the song following the current song
                $("#next").click(function(){
                    /*if(music_ind >= music_list.length){
                        music_ind = 0;
                    }*/
                    
                    if(audio !== null){
                        checkTmp(aud_tmp_pl); 
                        audio.pause();
                        audio.currentTime = 0; 
                    }
                    music_ind = (music_ind + 1) % music_list.length;
                    audio = music_list[music_ind];
                    $("#currently_playing").empty();
                    $("#currently_playing").append(music_titles_list[music_ind]);
                    checkVol(audio);
                    checkDur(audio);
                    p_bar_w = 1;
                    audio.play();
                })
                // skip backward from current song
                $("#prev").click(function(){
                    if(audio !== null){ 
                        checkTmp(aud_tmp_pl);
                        audio.pause();
                        audio.currentTime = 0; 
                    }
                    music_ind -= 1;
                    if(music_ind < 0){
                        music_ind = music_list.length - 1;
                    }
                    audio = music_list[music_ind];
                    $("#currently_playing").empty();
                    $("#currently_playing").append(music_titles_list[music_ind]);
                    checkVol(audio);
                    checkDur(audio);
                    p_bar_w = 1;
                    audio.play();
                })
                // Delete will first see if a given song has had it's checkbox marked, and if it has
                // then that song will be removed from the playlist
                $("#delete").click(function(){
                    var chequebox;
                    var path_del = "./data/" + user + "/music/"; // path relative to main.js
                    fs.readdir("./data/" + user + "/music",(err,files) =>{
                        if(err) throw err;
                      
                        for(var i = 0; i < files.length; i++) 
                        {
                            id = "song" + i;
                            chequebox = document.getElementById(id);
                            if(chequebox.checked){
                                var audio_path_del = path_del + files[i];
                                fs.unlinkSync(audio_path_del,(err) => {if (err) throw err; });
                            }
                        }
                        $("#currently_playing").empty();
                        showMusic();
                    })
                })
                musicThread.on("changeThemeMode",changeThemeMode);
            })

        </script>
    </body>
</html>